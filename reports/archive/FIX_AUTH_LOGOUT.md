# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã Logout (401 Unauthorized)

**–î–∞—Ç–∞:** 4 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üêõ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã (logout) –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:

```
/api/auth/logout:1  Failed to load resource: the server responded with a status of 401 (Unauthorized)
Error: –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω
```

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**Frontend** –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–ª JWT —Ç–æ–∫–µ–Ω –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ:

1. ‚ùå **Backend** –≤–æ–∑–≤—Ä–∞—â–∞–ª —Ç–æ–∫–µ–Ω –≤ `response.data.token`
2. ‚ùå **Frontend** –ø—ã—Ç–∞–ª—Å—è –≤–∑—è—Ç—å `response.accessToken` (–∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ –±—ã–ª–æ!)
3. ‚ùå –¢–æ–∫–µ–Ω –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è –≤ localStorage
4. ‚ùå –ü—Ä–∏ logout —Ç–æ–∫–µ–Ω–∞ –Ω–µ –±—ã–ª–æ ‚Üí –æ—à–∏–±–∫–∞ 401

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. Frontend - –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞

**–§–∞–π–ª:** `src/api/auth.js`

#### –î–æ:
```javascript
if (response.success && response.accessToken) {
  setAuthToken(response.accessToken);
}
```

#### –ü–æ—Å–ª–µ:
```javascript
// Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω –≤ data.token, –Ω–µ –≤ accessToken
if (response.success && response.data && response.data.token) {
  setAuthToken(response.data.token);
}
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤:**
- ‚úÖ `loginUser()` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ
- ‚úÖ `registerUser()` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ `apiRequest()` - —É–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ 401 –æ—à–∏–±–æ–∫

---

### 2. Frontend - –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤:**

```javascript
if (!response.ok) {
  // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω (401), —É–¥–∞–ª—è–µ–º –µ–≥–æ
  if (response.status === 401 && token) {
    console.warn('‚ö†Ô∏è –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫, —É–¥–∞–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ');
    removeAuthToken();
  }
  
  throw new Error(data.message || data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
}
```

---

### 3. Backend - –ù–∞–¥–µ–∂–Ω—ã–π Logout

**–§–∞–π–ª:** `server/index.js` (—Å—Ç—Ä–æ–∫–∏ 1162-1201)

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:

1. ‚úÖ **Logout –±–µ–∑ —Ç–æ–∫–µ–Ω–∞** —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—Ö (–Ω–µ 401)
2. ‚úÖ **–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω** –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç logout
3. ‚úÖ **–û—à–∏–±–∫–∏ –ë–î** –Ω–µ –º–µ—à–∞—é—Ç –≤—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

```javascript
// –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞, –≤—Å–µ —Ä–∞–≤–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö
if (!authHeader || !authHeader.startsWith('Bearer ')) {
  console.log('‚ö†Ô∏è Logout –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö');
  return res.json({ 
    success: true, 
    message: '–£—Å–ø–µ—à–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã' 
  });
}

// –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Ç–æ–∫–µ–Ω–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö
try {
  const decoded = jwt.verify(token, config.jwtSecret);
  await query('DELETE FROM user_sessions WHERE user_id = $1', [decoded.userId]);
} catch (tokenError) {
  console.log('‚ö†Ô∏è –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–∏ logout, –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö');
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Frontend

```powershell
# –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –≥–¥–µ –∑–∞–ø—É—â–µ–Ω frontend –Ω–∞–∂–º–∏—Ç–µ Ctrl+C
# –ò–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å:
Get-Process node | Stop-Process -Force

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ
cd C:\Users\kiy02\Desktop\CURSOR\Smeta360-3
npm start
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä:** http://localhost:3000
2. **–û—Ç–∫—Ä–æ–π—Ç–µ DevTools:** F12 ‚Üí –≤–∫–ª–∞–¥–∫–∞ Console
3. **–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É:** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω:**
   ```javascript
   // –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
   localStorage.getItem('authToken')
   // –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å JWT —Ç–æ–∫–µ–Ω (–¥–ª–∏–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞)
   ```
5. **–í—ã–π–¥–∏—Ç–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã**
6. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:** Logout –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏ –ë–ï–ó –æ—à–∏–±–æ–∫ 401

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞

### –í –±—Ä–∞—É–∑–µ—Ä–µ (DevTools Console):

```javascript
// –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω
const token = localStorage.getItem('authToken');
console.log('Token:', token);

// –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏)
function parseJwt(token) {
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
  return JSON.parse(jsonPayload);
}

// –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
console.log('Token payload:', parseJwt(token));
// –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: { userId: ..., email: ..., firstname: ..., lastname: ..., iat: ..., exp: ... }
```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–æ–∫–µ–Ω–∞

Backend —Å–æ–∑–¥–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:

```javascript
{
  userId: 123,              // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  email: "user@example.com",
  firstname: "–ò–≤–∞–Ω",
  lastname: "–ò–≤–∞–Ω–æ–≤",
  iat: 1234567890,         // –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è (Unix timestamp)
  exp: 1234654290          // –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è (24 —á–∞—Å–∞)
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ù–ï–¢ `tenant_id` –≤ —Ç–æ–∫–µ–Ω–µ, —Ç–∞–∫ –∫–∞–∫ —Ç–∞–±–ª–∏—Ü—ã `tenants` –∏ `user_tenants` –Ω–µ —Å–æ–∑–¥–∞–Ω—ã –≤ –ë–î. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ –±–µ–∑ –ø–æ–ª–Ω–æ–π –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏.

---

## üîê –û —Ç–µ–Ω–∞–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

- ‚ùå –¢–∞–±–ª–∏—Ü—ã `tenants` –∏ `user_tenants` **–Ω–µ —Å–æ–∑–¥–∞–Ω—ã** –≤ –ë–î
- ‚úÖ –ü–æ–ª–µ `tenant_id` –µ—Å—Ç—å –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö (`user_role_assignments`, `object_parameters`, –∏ –¥—Ä.)
- ‚úÖ Middleware `tenantContextMiddleware` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç **–ë–ï–ó —Ç–µ–Ω–∞–Ω—Ç–æ–≤** –≤ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ

### –î–ª—è –ø–æ–ª–Ω–æ–π —Ç–µ–Ω–∞–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è:

1. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã `tenants` –∏ `user_tenants`
2. –î–æ–±–∞–≤–∏—Ç—å `tenant_id` –≤ —Ç–æ–∫–µ–Ω –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `tenantContextMiddleware` –¥–ª—è –≤—Å–µ—Ö –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
4. –î–æ–±–∞–≤–∏—Ç—å `tenant_id` –≤ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π

**–ù–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ä–∞–±–æ—Ç—ã —ç—Ç–æ –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ë–ï–ó —Ç–µ–Ω–∞–Ω—Ç–æ–≤.**

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

1. ‚úÖ –¢–æ–∫–µ–Ω **—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è** –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
2. ‚úÖ –¢–æ–∫–µ–Ω **–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è** –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –ø—Ä–∏ logout
3. ‚úÖ Logout **—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** –±–µ–∑ –æ—à–∏–±–æ–∫ 401
4. ‚úÖ –°–∏—Å—Ç–µ–º–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç** –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
5. ‚úÖ Logout **–≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—Ö**, –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Ç–æ–∫–µ–Ω–æ–º

---

## üìù –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

- ‚úÖ `src/api/auth.js` - 3 —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ `server/index.js` - endpoint `/api/auth/logout` –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ **–ø–æ–ª–Ω–∞—è –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å**:

1. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Ç–∞–±–ª–∏—Ü `tenants` –∏ `user_tenants`
2. –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–Ω –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è `tenant_id` –≤ —Ç–æ–∫–µ–Ω
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Row Level Security (RLS) –≤ PostgreSQL
4. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ `tenant_id`

**–ù–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ.**

---

_–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞: 4 –æ–∫—Ç—è–±—Ä—è 2025_

