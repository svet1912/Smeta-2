# üèóÔ∏è –ê–ù–ê–õ–ò–ó –ú–£–õ–¨–¢–ò–¢–ï–ù–ê–ù–¢–ù–û–ô –ê–†–•–ò–¢–ï–ö–¢–£–†–´ SMETA-1

*–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 5 –æ–∫—Ç—è–±—Ä—è 2025*  
*–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: Aiven Cloud PostgreSQL 17.6*  
*–ò—Å—Ç–æ—á–Ω–∏–∫: –†–µ–∞–ª—å–Ω–∞—è production –ë–î*

---

## üìã **–ö–†–ê–¢–ö–ò–ï –û–¢–í–ï–¢–´ –ü–û –ü–£–ù–ö–¢–ê–ú**

### üèóÔ∏è **1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è**

**–û—Ç–≤–µ—Ç: a) –û–¥–Ω–∞ –ë–î, –æ–±—â–∞—è —Å—Ö–µ–º–∞, –∫–æ–ª–æ–Ω–∫–∞ tenant_id –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö**

- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ–¥–∏–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö `defaultdb`
- ‚úÖ –û–±—â–∞—è —Å—Ö–µ–º–∞ `public` –¥–ª—è –≤—Å–µ—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤  
- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ –∫–æ–ª–æ–Ω–∫—É `tenant_id` (—Ç–∏–ø `uuid`)

### üë• **2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤**

**2 –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–∞:**
- `"Test Company RLS"`
- `"Test Company for Auth"`

**–û—Å–Ω–æ–≤–Ω–æ–π tenant_id –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏:** `5a1f0a53-9f0b-4137-a82a-6302bc993c54`

---

## üóÇÔ∏è **3. –¢–∞–±–ª–∏—Ü—ã-¬´–∫–æ—Ä–Ω–∏¬ª –∏ ¬´–¥–µ—Ç–∏¬ª**

### üå≥ **–ö–æ—Ä–Ω–µ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–ë–ï–ó tenant_id):**

| –¢–∞–±–ª–∏—Ü–∞ | tenant_id | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----------|--------|----------|
| `tenants` | ‚ùå –ù–ï–¢ | üè¢ –ö–û–†–ï–ù–¨ | –°–∞–º–∞ —Ç–∞–±–ª–∏—Ü–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π |
| `auth_users` | ‚ùå –ù–ï–¢ | üë§ –ì–õ–û–ë–ê–õ–¨–ù–´–ï | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–∞—Ö |
| `user_roles` | ‚ùå –ù–ï–¢ | üîê –ì–õ–û–ë–ê–õ–¨–ù–´–ï | –†–æ–ª–∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–µ–∂–¥—É —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏ |
| `permissions` | ‚ùå –ù–ï–¢ | üîí –ì–õ–û–ë–ê–õ–¨–ù–´–ï | –†–∞–∑—Ä–µ—à–µ–Ω–∏—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ |
| `phases` | ‚ùå –ù–ï–¢ | üìö –°–ü–†–ê–í–û–ß–ù–ò–ö | –§–∞–∑—ã —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ (540 –∑–∞–ø–∏—Å–µ–π) |
| `stages` | ‚ùå –ù–ï–¢ | üìö –°–ü–†–ê–í–û–ß–ù–ò–ö | –°—Ç–∞–¥–∏–∏ —Ä–∞–±–æ—Ç (15 –∑–∞–ø–∏—Å–µ–π) |
| `substages` | ‚ùå –ù–ï–¢ | üìö –°–ü–†–ê–í–û–ß–ù–ò–ö | –ü–æ–¥—Å—Ç–∞–¥–∏–∏ —Ä–∞–±–æ—Ç (43 –∑–∞–ø–∏—Å–∏) |
| `work_materials` | ‚ùå –ù–ï–¢ | üìö –°–ü–†–ê–í–û–ß–ù–ò–ö | –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏ —Ä–∞–±–æ—Ç-–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (1,425 –∑–∞–ø–∏—Å–µ–π) |

### üåø **–¢–∞–±–ª–∏—Ü—ã —Å tenant_id:**

#### **–£—Ä–æ–≤–µ–Ω—å 1 - –°–≤—è–∑—å —Å —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏:**
| –¢–∞–±–ª–∏—Ü–∞ | tenant_id | –†–æ–¥–∏—Ç–µ–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----------|----------|----------|
| `user_tenants` | ‚úÖ –ï–°–¢–¨ | tenants | –ü—Ä–∏–≤—è–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º |
| `user_role_assignments` | ‚úÖ –ï–°–¢–¨ | tenants | –†–æ–ª–∏ –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–Ω–∞–Ω—Ç–∞ |

#### **–£—Ä–æ–≤–µ–Ω—å 2 - –ü—Ä–æ–µ–∫—Ç—ã –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏:**
| –¢–∞–±–ª–∏—Ü–∞ | tenant_id | –†–æ–¥–∏—Ç–µ–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----------|----------|----------|
| `projects` | ‚úÖ –ï–°–¢–¨ | tenants | –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ |
| `construction_projects` | ‚úÖ –ï–°–¢–¨ | tenants | –£—Å—Ç–∞—Ä–µ–≤—à–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ |

#### **–£—Ä–æ–≤–µ–Ω—å 3 - –°–º–µ—Ç—ã –∏ —Ä–∞—Å—á–µ—Ç—ã:**
| –¢–∞–±–ª–∏—Ü–∞ | tenant_id | –†–æ–¥–∏—Ç–µ–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----------|----------|----------|
| `estimates` | ‚úÖ –ï–°–¢–¨ | projects + tenants | –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–º–µ—Ç—ã |
| `customer_estimates` | ‚úÖ –ï–°–¢–¨ ‚ö†Ô∏è | projects + tenants | –°–º–µ—Ç—ã –∑–∞–∫–∞–∑—á–∏–∫–∞ |
| `estimate_items` | ‚úÖ –ï–°–¢–¨ | estimates + tenants | –≠–ª–µ–º–µ–Ω—Ç—ã —Å–º–µ—Ç |
| `customer_estimate_items` | ‚úÖ –ï–°–¢–¨ | customer_estimates + tenants | –≠–ª–µ–º–µ–Ω—Ç—ã —Å–º–µ—Ç –∑–∞–∫–∞–∑—á–∏–∫–∞ |

#### **–£—Ä–æ–≤–µ–Ω—å 4 - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—ä–µ–∫—Ç–æ–≤:**
| –¢–∞–±–ª–∏—Ü–∞ | tenant_id | –†–æ–¥–∏—Ç–µ–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----------|----------|----------|
| `object_parameters` | ‚úÖ –ï–°–¢–¨ | projects + tenants | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—ä–µ–∫—Ç–æ–≤ |
| `project_rooms` | ‚úÖ –ï–°–¢–¨ | object_parameters + tenants | –ü–æ–º–µ—â–µ–Ω–∏—è |
| `constructive_elements` | ‚úÖ –ï–°–¢–¨ | object_parameters + tenants | –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã |
| `engineering_systems` | ‚úÖ –ï–°–¢–¨ | object_parameters + tenants | –ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã |

#### **–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –ü–û –¢–ï–ù–ê–ù–¢–ê–ú:**
| –¢–∞–±–ª–∏—Ü–∞ | tenant_id | –†–æ–¥–∏—Ç–µ–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----------|----------|----------|
| `materials` | ‚úÖ –ï–°–¢–¨ | tenants | –ú–∞—Ç–µ—Ä–∏–∞–ª—ã (1,448 –∑–∞–ø–∏—Å–µ–π) |
| `works_ref` | ‚úÖ –ï–°–¢–¨ | tenants | –†–∞–±–æ—Ç—ã (540 –∑–∞–ø–∏—Å–µ–π) |
| `work_materials_tenant` | ‚úÖ –ï–°–¢–¨ | tenants | –¢–µ–Ω–∞–Ω—Ç–Ω—ã–µ —Å–≤—è–∑–∏ —Ä–∞–±–æ—Ç-–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ |

#### **–¢–µ–Ω–∞–Ω—Ç–Ω—ã–µ —Ü–µ–Ω—ã:**
| –¢–∞–±–ª–∏—Ü–∞ | tenant_id | –†–æ–¥–∏—Ç–µ–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----------|----------|----------|
| `tenant_material_prices` | ‚úÖ –ï–°–¢–¨ | materials + tenants | –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ |
| `tenant_work_prices` | ‚úÖ –ï–°–¢–¨ | works_ref + tenants | –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ü–µ–Ω–∫–∏ —Ä–∞–±–æ—Ç |
| `tenant_counters` | ‚úÖ –ï–°–¢–¨ | tenants | –°—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ |

---

## üîí **4. –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ ¬´–≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–Ω–∞–Ω—Ç–∞¬ª**

### **–ù–∞–π–¥–µ–Ω–Ω—ã–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**

#### ‚úÖ **–†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
```sql
user_role_assignments: (user_id, role_id, tenant_id) UNIQUE
```
**–ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ä–æ–ª—å —Ç–æ–ª—å–∫–æ –û–î–ò–ù —Ä–∞–∑ –≤ –∫–∞–∂–¥–æ–º —Ç–µ–Ω–∞–Ω—Ç–µ

#### ‚úÖ **–¶–µ–Ω—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:**
```sql
tenant_material_prices: (tenant_id, material_id, valid_from) PRIMARY KEY
```
**–ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º:** –£ –∫–∞–∂–¥–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Ü–µ–Ω–∞ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É

#### ‚úÖ **–†–∞—Å—Ü–µ–Ω–∫–∏ —Ä–∞–±–æ—Ç:**
```sql
tenant_work_prices: (tenant_id, work_id, valid_from) PRIMARY KEY  
```
**–ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º:** –£ –∫–∞–∂–¥–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Ä–∞—Å—Ü–µ–Ω–∫–∞ –Ω–∞ —Ä–∞–±–æ—Ç—É –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É

#### ‚úÖ **–¢–µ–Ω–∞–Ω—Ç–Ω—ã–µ —Å–≤—è–∑–∏ —Ä–∞–±–æ—Ç-–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:**
```sql
work_materials_tenant: (tenant_id, work_id, material_id) PRIMARY KEY
```
**–ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º:** –£ –∫–∞–∂–¥–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å–≤—è–∑—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –º–∞—Ç–µ—Ä–∏–∞–ª–æ–º

---

## üîó **5. –°–≤—è–∑–Ω–æ—Å—Ç—å –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å**

### üö® **–ü–†–û–ë–õ–ï–ú–´:**

#### **–ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å tenant_id:**
```json
// –í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –≤ –æ–¥–Ω–æ–º —Ç–µ–Ω–∞–Ω—Ç–µ
{"id":"7254de1c-d7d0-44d9-a4d2-9c2b7482a5b4","tenant_id":"5a1f0a53-9f0b-4137-a82a-6302bc993c54"}

// –ù–û —Å–º–µ—Ç–∞ –∑–∞–∫–∞–∑—á–∏–∫–∞ –ë–ï–ó —Ç–µ–Ω–∞–Ω—Ç–∞!
{"id":23,"tenant_id":null}  ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê
```

#### **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–≤–∏–ª–æ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:**
- ‚ùå –î–æ—á–µ—Ä–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ù–ï –í–°–ï–ì–î–ê –Ω–∞—Å–ª–µ–¥—É—é—Ç tenant_id –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è
- ‚ùå –í–æ–∑–º–æ–∂–Ω—ã "—Å–∏—Ä–æ—Ç—ã" –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Ç–µ–Ω–∞–Ω—Ç—É
- ‚ùå –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏

---

## üõ°Ô∏è **6. RLS / –∏–∑–æ–ª—è—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î**

### ‚úÖ **Row-Level Security –í–ö–õ–Æ–ß–ï–ù:**

**RLS –∞–∫—Ç–∏–≤–µ–Ω –Ω–∞ 8 —Ç–∞–±–ª–∏—Ü–∞—Ö:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∫–æ–º–∞–Ω–¥–æ–π:
SELECT schemaname, tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' AND rowsecurity = true;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** RLS –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –Ω–æ —Ç–æ—á–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ —Ç—Ä–µ–±—É—é—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

### **–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞:**
- üîí **–£—Ä–æ–≤–µ–Ω—å –ë–î:** RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞ 8 —Ç–∞–±–ª–∏—Ü–∞—Ö
- üîí **–£—Ä–æ–≤–µ–Ω—å API:** –§–∏–ª—å—Ç—Ä—ã –ø–æ tenant_id –≤ middleware

---

## üö® **7. –ß—Ç–æ —Å–µ–π—á–∞—Å –ª–æ–º–∞–µ—Ç—Å—è/—Ç—Ä–µ–≤–æ–∂–∏—Ç**

### **üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**

#### **1. –°–º–µ—Ç—ã-"—Å–∏—Ä–æ—Ç—ã" –±–µ–∑ tenant_id:**
```json
customer_estimates: {"id":23,"tenant_id":null}
```
**–ü—Ä–æ—è–≤–ª–µ–Ω–∏–µ:** –°–º–µ—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∏–¥–Ω–∞ –≤—Å–µ–º —Ç–µ–Ω–∞–Ω—Ç–∞–º –∏–ª–∏ –Ω–∏–∫–æ–º—É, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç RLS –ø–æ–ª–∏—Ç–∏–∫

#### **2. –°–º–µ—à–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤:**
- `work_materials` (1,425 –∑–∞–ø–∏—Å–µ–π) ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏
- `work_materials_tenant` (1 –∑–∞–ø–∏—Å—å) ‚Äî —Ç–µ–Ω–∞–Ω—Ç–Ω—ã–µ —Å–≤—è–∑–∏

**–ü—Ä–æ—è–≤–ª–µ–Ω–∏–µ:** –ü—É—Ç–∞–Ω–∏—Ü–∞ –≤ —Ç–æ–º, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ, –∞ –∫–∞–∫–∏–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ

### **‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

#### **3. –î–≤–æ–π–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤:**
- `construction_projects` (6 –∑–∞–ø–∏—Å–µ–π) ‚Äî —Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞
- `projects` (3 –∑–∞–ø–∏—Å–∏) ‚Äî –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞

**–ü—Ä–æ—è–≤–ª–µ–Ω–∏–µ:** –í–æ–∑–º–æ–∂–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

#### **4. –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–µ —Ç–∏–ø—ã tenant_id:**
- `construction_projects.tenant_id` ‚Äî `character varying`
- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã ‚Äî `uuid`

**–ü—Ä–æ—è–≤–ª–µ–Ω–∏–µ:** –°–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏ JOIN –æ–ø–µ—Ä–∞—Ü–∏—è—Ö –∏ –º–∏–≥—Ä–∞—Ü–∏—è—Ö –¥–∞–Ω–Ω—ã—Ö

---

## üìä **–°–¢–ê–¢–ò–°–¢–ò–ö–ê –†–ï–ê–õ–¨–ù–û–ì–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø**

### **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–µ–Ω–∞–Ω—Ç–∞–º:**

| –¢–∞–±–ª–∏—Ü–∞ | –û–±—â–∏–π tenant_id | –ó–∞–ø–∏—Å–µ–π | –°—Ç–∞—Ç—É—Å |
|---------|-----------------|---------|--------|
| `projects` | `5a1f0a53-9f0b-4137-a82a-6302bc993c54` | 3 | ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ |
| `estimates` | `5a1f0a53-9f0b-4137-a82a-6302bc993c54` | 3 | ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ |
| `customer_estimates` | `null` | 1 | üö® –ü–†–û–ë–õ–ï–ú–ê |
| `user_tenants` | –°–º–µ—à–∞–Ω–Ω–æ | 2 | ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ |

### **–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–Ω–∞–Ω—Ç—ã –≤ —Å–∏—Å—Ç–µ–º–µ:**
- **–¢–µ–Ω–∞–Ω—Ç 1:** `5a1f0a53-9f0b-4137-a82a-6302bc993c54` (–æ—Å–Ω–æ–≤–Ω–æ–π)
- **–¢–µ–Ω–∞–Ω—Ç 2:** `cd5ffb0f-8616-4227-a056-4f729ed6933c` (—Ç–µ—Å—Ç–æ–≤—ã–π)

---

## ‚ö†Ô∏è **–ù–ï –ü–ï–†–ï–•–û–î–ò–ú –ö –°–õ–ï–î–£–Æ–©–ï–ú–£ –®–ê–ì–£**

**–§–∞–∫—Ç—ã —Å–æ–±—Ä–∞–Ω—ã. –ñ–¥–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫:**
- **–®–∞–≥ 2:** –¢–æ—á–Ω–∞—è –∫–∞—Ä—Ç–∞ –¥—ã—Ä –∏ –ø–ª–∞–Ω –ø—Ä–∞–≤–æ–∫
- **–®–∞–≥ 3:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º
- **–®–∞–≥ 4:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

---

*–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ production –ë–î*  
*–í—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã*
üìã –®–ê–ì 2 ‚Äî –°–û–ì–õ–ê–°–û–í–ê–ù–ò–ï –¶–ï–õ–ï–í–û–ô –ú–û–î–ï–õ–ò
2.1. –†–æ–¥–∏—Ç–µ–ª–∏ –∏ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ tenant_id
projects ‚Äî –æ—Å—Ç–∞—ë—Ç—Å—è –∫–æ—Ä–Ω–µ–≤—ã–º –∞–≥—Ä–µ–≥–∞—Ç–æ–º?
–î–∞

estimates ‚Äî –¥–æ—á–µ—Ä–Ω—è—è –∫ projects, tenant_id –≤—Å–µ–≥–¥–∞ —Ä–∞–≤–µ–Ω projects.tenant_id, tenant_id –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å NULL.
–î–∞

customer_estimates ‚Äî –¥–æ—á–µ—Ä–Ω—è—è –∫ projects –∏–ª–∏ –∫ estimates?
A) –ø—Ä–∏–≤—è–∑–∫–∞ –∫ projects
(customer_estimates ‚Äî —ç—Ç–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ç–∏–ø —Å–º–µ—Ç—ã, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π —Å estimates, –æ–±–∞ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –ø—Ä–æ–µ–∫—Ç—É)

NULL –∑–∞–ø—Ä–µ—â—ë–Ω, –≤—Å–µ–≥–¥–∞ = —Ä–æ–¥–∏—Ç–µ–ª—é: –î–∞

object_parameters ‚Äî –∫ —á–µ–º—É –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω—ã:
A) –∫ projects (–æ–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—ä–µ–∫—Ç–∞)
(–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—ä–µ–∫—Ç–∞ –æ–ø–∏—Å—ã–≤–∞—é—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –ø—Ä–æ–µ–∫—Ç—É –≤ —Ü–µ–ª–æ–º, –∞ –Ω–µ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–º–µ—Ç–µ)

tenant_id –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ = —Ä–æ–¥–∏—Ç–µ–ª—é: –î–∞

2.2. –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ / –∫–∞—Ç–∞–ª–æ–≥
–ú–∞—Ç–µ—Ä–∏–∞–ª—ã / —Ä–∞–±–æ—Ç—ã: —Å–µ–π—á–∞—Å materials –∏ works_ref —É–∂–µ —Ç–µ–Ω–∞–Ω—Ç–Ω—ã–µ ‚Äî —ç—Ç–æ –æ–∫?
–î–∞
(–∫–∞–∂–¥–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∏–º–µ–µ—Ç —Å–≤–æ–∏ —Ä–∞—Å—Ü–µ–Ω–∫–∏ –∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤)

–°–≤—è–∑–∏ "—Ä–∞–±–æ—Ç–∞ ‚Üî –º–∞—Ç–µ—Ä–∏–∞–ª—ã": —á—Ç–æ –≤—ã–±–∏—Ä–∞–µ–º –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã?
A) –¢–æ–ª—å–∫–æ —Ç–µ–Ω–∞–Ω—Ç–Ω—ã–µ —Å–≤—è–∑–∏ (work_materials_tenant)
(–∫–∞–∂–¥–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å —Å–≤–æ–∏ –Ω–æ—Ä–º—ã —Ä–∞—Å—Ö–æ–¥–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤)

phases / stages / substages (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–µ–π—á–∞—Å):
A) –û—Å—Ç–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ (–µ–¥–∏–Ω–∞—è —Ç–∞–∫—Å–æ–Ω–æ–º–∏—è –¥–ª—è –≤—Å–µ—Ö)
(—Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –µ–¥–∏–Ω—ã–º–∏)

2.3. –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ "–≤ —Ä–∞–º–∫–∞—Ö‚Ä¶"
–ö–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ (project_code) ‚Äî —É–Ω–∏–∫–∞–ª–µ–Ω:
A) –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–Ω–∞–Ω—Ç–∞
(–∫–∞–∂–¥–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ—é —Å–∏—Å—Ç–µ–º—É –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è)

–ù–æ–º–µ—Ä —Å–º–µ—Ç—ã (estimate_number) ‚Äî —É–Ω–∏–∫–∞–ª–µ–Ω:
A) –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞
(–≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –Ω–æ–º–µ—Ä–æ–≤ —Å–º–µ—Ç)

2.4. RLS-–∏–∑–æ–ª—è—Ü–∏—è
RLS –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∫–ª—é—á—ë–Ω –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö, –≥–¥–µ –µ—Å—Ç—å tenant_id:
–î–∞

–ü–æ–ª–∏—Ç–∏–∫–∞ RLS: ¬´–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ tenant_id = —Ç–µ–∫—É—â–µ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É¬ª:
–î–∞

2.5. –ü—Ä–∏–ª–æ–∂–µ–Ω—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
–ö–∞–∫ —Å–µ–π—á–∞—Å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è "—Ç–µ–∫—É—â–∏–π —Ç–µ–Ω–∞–Ω—Ç":
A) –ò–∑ JWT —á–∏—Ç–∞–µ–º tenant_id, –∫–ª–∞–¥—ë–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏ –ë–î
(–≤ –∫–æ–¥–µ —É–∂–µ –µ—Å—Ç—å tenantContextMiddleware, –∫–æ—Ç–æ—Ä—ã–π —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç app.tenant_id)

–î–æ–ª–∂–Ω—ã –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–æ–ª–µ–π –≤ —Ä–∞–∑–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–∞—Ö —á–µ—Ä–µ–∑ user_tenants?
–î–∞
(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º–∏ –≤ —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª—è—Ö)

2.6. –ü—Ä–æ–±–ª–µ–º—ã –¥–ª—è —Ñ–∏–∫—Å–∞ "–≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å"
–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Ññ1: –∑–∞–ø—Ä–µ—Ç–∏—Ç—å tenant_id = NULL –≤ customer_estimates –∏ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ NULL-–∑–∞–ø–∏—Å–∏?
–î–∞

–ù—É–∂–Ω–æ –ª–∏ —Å–µ–π—á–∞—Å —Å–¥–µ–ª–∞—Ç—å –±—ã—Å—Ç—Ä—É—é —Å–≤–µ—Ä–∫—É —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏?
–î–∞
(–≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å tenant_id, —Å–æ–≤–ø–∞–¥–∞—é—â–∏–π —Å projects.tenant_id)

üéØ –ì–û–¢–û–í –ö –®–ê–ì–£ 3
–¶–µ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞. –ñ–¥—É –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è: