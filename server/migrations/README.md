# SMETA360-2 Database Migration System

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π rollback –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏** —Å forward/rollback SQL
- ‚úÖ **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã** –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π** —Å post-migration checks
- ‚úÖ **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏
- ‚úÖ **Rollback –ø–æ–¥–¥–µ—Ä–∂–∫–∞** —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- ‚úÖ **Checksum verification** –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤
- ‚úÖ **CLI interface** –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
server/
‚îú‚îÄ‚îÄ migration-manager.js          # –û—Å–Ω–æ–≤–Ω–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–π
‚îú‚îÄ‚îÄ migrations/                   # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ 20251007120000_performance_indexes.sql
‚îÇ   ‚îú‚îÄ‚îÄ 20251007121000_multitenancy_enhancement.sql
‚îÇ   ‚îî‚îÄ‚îÄ 20251007122000_auth_security_enhancement.sql
‚îî‚îÄ‚îÄ backups/                     # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã
    ‚îî‚îÄ‚îÄ backup_[version]_[timestamp].sql
```

## üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
cd server
node migration-manager.js generate "add_user_preferences" "Add user preferences table"
```

–°–æ–∑–¥–∞—Å—Ç —Ñ–∞–π–ª —Å —à–∞–±–ª–æ–Ω–æ–º:
```sql
-- Migration: add_user_preferences
-- Version: 20251007123000_add_user_preferences
-- Description: Add user preferences table

-- ============================
-- FORWARD MIGRATION (UP)
-- ============================
-- –í–∞—à SQL –∫–æ–¥ –∑–¥–µ—Å—å

-- ============================
-- ROLLBACK MIGRATION (DOWN)
-- ============================
-- ROLLBACK_START
-- SQL –¥–ª—è –æ—Ç–∫–∞—Ç–∞
-- ROLLBACK_END

-- ============================
-- POST MIGRATION VALIDATION
-- ============================
-- VALIDATION_START
-- –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
-- VALIDATION_END
```

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
# Dry run - –ø–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–æ
node migration-manager.js migrate --dry-run

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ pending –º–∏–≥—Ä–∞—Ü–∏–∏ —Å –±—ç–∫–∞–ø–∞–º–∏
node migration-manager.js migrate

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–æ–≤ (–±—ã—Å—Ç—Ä–µ–µ)
node migration-manager.js migrate --no-backup
```

### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π

```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
node migration-manager.js rollback

# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–∏–≥—Ä–∞—Ü–∏–∏
node migration-manager.js rollback 3
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
node migration-manager.js status
```

–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
```
Migration Status:
  Total migrations: 6
  Applied: 3
  Pending: 3

Pending migrations:
  - 20251007120000_performance_indexes: 20251007120000_performance_indexes.sql
  - 20251007121000_multitenancy_enhancement: 20251007121000_multitenancy_enhancement.sql
  - 20251007122000_auth_security_enhancement: 20251007122000_auth_security_enhancement.sql
```

## üìä –ì–æ—Ç–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### 1. Performance Indexes (20251007120000)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- GIN –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ø—Ä–æ–µ–∫—Ç–∞–º –∏ —Ä–∞–±–æ—Ç–∞–º
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ –¥–∞—Ç–µ

**–û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ**: 
- –ü–æ–∏—Å–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: 1211ms ‚Üí <200ms
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: 1206ms ‚Üí <100ms  
- –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: 1198ms ‚Üí <300ms

### 2. Multitenancy Enhancement (20251007121000)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `tenants` —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ `tenant_id` –≤–æ –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- Row Level Security (RLS) –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è tenant –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤ default tenant

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
- –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ RLS –ø–æ–ª–∏—Ç–∏–∫–∞–º
- –ó–∞—â–∏—Ç–∞ –æ—Ç cross-tenant –¥–æ—Å—Ç—É–ø–∞

### 3. Auth Security Enhancement (20251007122000)  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –¢–∞–±–ª–∏—Ü–∞ `refresh_tokens` –¥–ª—è JWT refresh –º–µ—Ö–∞–Ω–∏–∑–º–∞
- –°–∏—Å—Ç–µ–º–∞ `user_sessions` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏
- –¢–∞–±–ª–∏—Ü–∞ `login_attempts` –¥–ª—è rate limiting
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ password reset tokens
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 2FA (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞)

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
- Rate limiting –ø–æ IP –∏ email
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –±—Äute force
- Revocation –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- Cleanup expired tokens

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
```javascript
await client.query('BEGIN');
try {
  // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
  await client.query(migrationSQL);
  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  await client.query(validationSQL);
  // –ó–∞–ø–∏—Å—å –≤ schema_migrations
  await client.query(recordSQL);
  await client.query('COMMIT');
} catch (error) {
  await client.query('ROLLBACK');
  throw error;
}
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã
- –°–æ–∑–¥–∞—é—Ç—Å—è –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ `pg_dump`
- –°—Ö–µ–º–∞-only –±—ç–∫–∞–ø—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- –•—Ä–∞–Ω—è—Ç—Å—è –≤ `server/backups/` —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏

### –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
```sql
-- VALIDATION_START
SELECT COUNT(*) FROM new_table WHERE required_field IS NOT NULL;
SELECT schemaname, indexname FROM pg_indexes WHERE indexname = 'new_index';
-- VALIDATION_END
```

### Rollback –º–µ—Ö–∞–Ω–∏–∑–º
```sql
-- ROLLBACK_START
DROP INDEX IF EXISTS new_index;
DROP TABLE IF EXISTS new_table;
-- ROLLBACK_END
```

## üìà Production Deployment

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
DATABASE_URL=postgresql://user:pass@host:5432/database
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CI/CD
```yaml
# .github/workflows/deploy.yml
- name: Run Database Migrations
  run: |
    cd server
    node migration-manager.js migrate
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–∏–≥—Ä–∞—Ü–∏–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `migration.log`
- Tracking –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- Checksum verification –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
- Audit trail –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã

## üö® Best Practices

### –ù–∞–ø–∏—Å–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
1. **–í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π—Ç–µ rollback SQL** –≤ ROLLBACK_START/END –±–ª–æ–∫–∏
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ IF NOT EXISTS** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
3. **–î–æ–±–∞–≤–ª—è–π—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é** –≤ VALIDATION_START/END –±–ª–æ–∫–∏
4. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ rollback** –ø–µ—Ä–µ–¥ production deployment
5. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CONCURRENTLY** –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ production

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
1. **–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –±—ç–∫–∞–ø—ã** –ø–µ—Ä–µ–¥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
2. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ staging** –æ–∫—Ä—É–∂–µ–Ω–∏–∏
3. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –ø–æ—Å–ª–µ –∏–Ω–¥–µ–∫—Å–æ–≤
4. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏** –¥–ª—è data isolation

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
1. **–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–æ–≤** –ø–æ—Å–ª–µ –∏–Ω–¥–µ–∫—Å–æ–≤
2. **–û–±–Ω–æ–≤–ª—è–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É** —Å ANALYZE
3. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–æ–≤** –∏ disk usage
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü

## üîç Troubleshooting

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–ª–∞**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
SELECT pid, query, state FROM pg_stat_activity WHERE state = 'active';

# –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–≤–∏—Å—à–∏–π –ø—Ä–æ—Ü–µ—Å—Å
SELECT pg_terminate_backend(pid);
```

**Rollback –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ rollback SQL
SELECT version, rollback_sql FROM schema_migrations WHERE version = '20251007120000_performance_indexes';

# –í—ã–ø–æ–ª–Ω–∏—Ç—å rollback –≤—Ä—É—á–Ω—É—é
BEGIN;
-- –í—Å—Ç–∞–≤–∏—Ç—å rollback SQL
COMMIT;
```

**–ü—Ä–æ–±–ª–µ–º—ã —Å RLS**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏
SELECT schemaname, tablename, policyname FROM pg_policies;

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å tenant –∫–æ–Ω—Ç–µ–∫—Å—Ç
SELECT set_tenant_context('tenant-uuid');
```

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [Database Schema Documentation](../docs/DATABASE_SCHEMA.md)
- [Performance Optimization Guide](../PERFORMANCE_OPTIMIZATION_GUIDE.md)
- [Security Guidelines](../docs/SECURITY_CRITICAL.md)
- [Deployment Guide](../docs/DEPLOYMENT.md)